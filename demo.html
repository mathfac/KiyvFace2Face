
<!DOCTYPE html>

<html lang="en">
<head>
    <title>Betaface API - Face recognition webservice</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="css/jquery.dataTables.bootstrap.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="js/html5shiv.js"></script>
        <script src="js/respond.min.js"></script>
    <![endif]-->
    <!-- Contact Form CSS files -->
</head>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35035419-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<body>
    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/jquery.expander.min.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.dataTables.bootstrap.js"></script>
    <script src="js/image-scale.js"></script>
    <style>

        .thumb {
          height: 75px;
          border: 1px solid #000;
          margin: 2px 2px 2px 2px;
        }

        .thumb_c {
          height: 75px;
          border: 1px solid #000;
          margin: 2px 2px 2px 2px;
          cursor: pointer;
        }

        .modal-wide {
            width: 90%;
        }

        .image-image {
            height: 76vh;
        }

        .image-container
        {
            text-align: center;
        }
    </style>

    <div class="page-container">
        <nav class="navbar navbar-default" role="navigation">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://www.betaface.com"><img src="images/betaface_logo.png" ></a>
            </div>
        </nav>
        <div role="main" class="container">
        <h1>Select images</h1>
        <div id="input_file" class="container" style="margin-top: 10px">
            <input type="file" id="files" name="files[]" multiple />
        </div>
        <div id="input_url" class="container" style="margin-top: 10px">
            <input type="text" id="txtUrl" />
            <input type="button" id="btnUrl" value="Send image URL" onclick="doUploadUrl();" />
        </div>
        <h1>Matches</h1>
        <div id="matches" class="container" style="margin-top: 10px"></div>
        <h1>Faces</h1>
        <div id="faces" class="container" style="margin-top: 10px"></div>
        <h1>Images</h1>
        <div id="images" class="container" style="margin-top: 10px"></div>
        </div>
        <aside role="complementary">
        </aside>
        <footer class="footer" style="text-align: center; vertical-align:middle;">
            &copy; 2013-2014 <a href="http://www.betaface.com">Betaface</a>
        </footer>
    </div>

    <!-- Modal -->
    <div class="modal" id="myModal">
        <div class="modal-dialog modal-wide">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="imageHeader"></h4>
            </div>
            <div class="modal-body">
                <div class="image-container" id="imageContainer" >
                </div>
            </div>
            <div class="modal-footer">
            </div>
            </div><!-- /.modal-content >-->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <script>

        window.onload = function () {
            window.Images = [];
            window.Faces = [];
            window.Matches = [];
            window.modal_on = false;
            window.modal_is_image = false;
            window.modal_id = null;
            updateImages();
            updateFaces();
            updateMatches();
        }

        $(document).ready(function () {
            if (window.File && window.FileReader && window.FileList && window.Blob) {
            } else {
                alert('The File APIs are not fully supported in this browser, uploading local files might not function.');
            }

            $('.datatable').dataTable({
                "sPaginationType": "bs_normal"
            });
            $('.datatable').each(function () {
                var datatable = $(this);
                // SEARCH - Add the placeholder for Search and Turn this into in-line form control
                var search_input = datatable.closest('.dataTables_wrapper').find('div[id$=_filter] input');
                search_input.attr('placeholder', 'Search');
                search_input.addClass('form-control input-sm');
                // LENGTH - Inline-Form control
                var length_sel = datatable.closest('.dataTables_wrapper').find('div[id$=_length] select');
                length_sel.addClass('form-control input-sm');
            });

            $(window).resize(function () {
                updateModal();
            });
        });

        function getFaceImage(face_uid) {
            var msg = '<?xml version="1.0" encoding="utf-8"?><FaceRequestId><api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>' +
                    '<face_uid>' + face_uid + '</face_uid></FaceRequestId>';

            $.support.cors = true;
            $.ajax({
                crossDomain: true,
                url: 'http://www.betafaceapi.com/service.svc/GetFaceImage',
                type: 'post',
                contentType: 'application/xml',
                processData: false,
                data: msg,
                dataType: 'xml',
                success: function (data, textStatus, jqXHR) {
                    var xmlDocRoot = $.parseXML(jqXHR.responseText);
                    var xmlDoc = $(xmlDocRoot).children("BetafaceFaceImageResponse");
                    var int_response = parseInt($(xmlDoc).children("int_response").text());
                    var string_response = $(xmlDoc).children("string_response").text();
                    if (int_response == 0) {
                        var face_uid = $(xmlDoc).children("uid").text();
                        //
                        var face_image = $(xmlDoc).children("face_image").text();
                        var data_url = 'data:image/jpeg;base64,' + face_image;
                        //
                        var x = parseFloat($(xmlDoc).children("x").text());
                        var y = parseFloat($(xmlDoc).children("y").text());
                        var width = parseFloat($(xmlDoc).children("width").text());
                        var height = parseFloat($(xmlDoc).children("height").text());
                        var angle = parseFloat($(xmlDoc).children("angle").text());
                        //
                        var points = $(xmlDoc).children("face_info").children("points").children();
                        //
                        doUpdateFace(face_uid, data_url, x, y, width, height, angle, points);
                        //
                        if(window.modal_on && (!window.modal_is_image) && (window.modal_id === face_uid))
                        {
                            updateModal();
                        }
                    }
                    else {
                        //error
                        console.info(int_response);
                        console.info(string_response);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.info(textStatus);
                }
            });
        }

        function uploadImageImpl(url, msg, image_filename, image) {
            $.support.cors = true;
            $.ajax({
                crossDomain: true,
                url: url,
                type: 'post',
                contentType: 'application/xml',
                processData: false,
                data: msg,
                dataType: 'xml',
                success: function (data, textStatus, jqXHR) {
                    var xmlDocRoot = $.parseXML(jqXHR.responseText);
                    var xmlDoc = $(xmlDocRoot).children("BetafaceImageResponse");
                    var int_response = parseInt($(xmlDoc).children("int_response").text());
                    var string_response = $(xmlDoc).children("string_response").text();
                    if (int_response == 0) {
                        var image_uid = $(xmlDoc).children("img_uid").text();
                        doAddImage(image_uid, image_filename, image);
                    }
                    else {
                        //error
                        doUpdateImage(image_uid, string_response, 0);

                        console.info(int_response);
                        console.info(string_response);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.info(textStatus);
                }
            });
        }

        function uploadImageUrl(image_url, detection_flags) {
            if (image_url != null && image_url != '') {
                var msg = '<?xml version="1.0" encoding="utf-8"?><ImageRequestUrl xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">' +
                            '<api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>' +
                            '<detection_flags>' + detection_flags + '</detection_flags>' +
                            '<image_url>' + image_url + '</image_url>' +
                            '</ImageRequestUrl>';
                uploadImageImpl('http://www.betafaceapi.com/service.svc/UploadNewImage_Url', msg, image_url, image_url);
            }
        }

        function uploadImageFile(image_filename, image_data, detection_flags) {
            var prefix = ';base64,';
            var idx = image_data.indexOf(prefix);
            if (idx >= 0) {
                var base64_data = image_data.substring(idx + prefix.length);
                var msg = '<?xml version="1.0" encoding="utf-8"?><ImageRequestBinary xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">' +
                            '<api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>' +
                            '<detection_flags>' + detection_flags + '</detection_flags>' +
                            '<imagefile_data>' + base64_data + '</imagefile_data>' +
                            '<original_filename>' + image_filename + '</original_filename>' +
                            '</ImageRequestBinary>';

                uploadImageImpl('http://www.betafaceapi.com/service.svc/UploadNewImage_File', msg, image_filename, image_data);
            }
        }

        function getImageInfo(image_uid) {
            var msg = '<?xml version="1.0" encoding="utf-8"?><ImageInfoRequestUid><api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>' +
                    '<img_uid>' + image_uid + '</img_uid></ImageInfoRequestUid>';

            $.support.cors = true;
            $.ajax({
                crossDomain: true,
                url: 'http://www.betafaceapi.com/service.svc/GetImageInfo',
                type: 'post',
                contentType: 'application/xml',
                processData: false,
                data: msg,
                dataType: 'xml',
                success: function (data, textStatus, jqXHR) {
                    var xmlDocRoot = $.parseXML(jqXHR.responseText);
                    var xmlDoc = $(xmlDocRoot).children("BetafaceImageInfoResponse");
                    var int_response = parseInt($(xmlDoc).children("int_response").text());
                    var string_response = $(xmlDoc).children("string_response").text();
                    if (int_response == 1) {
                        //image is in the queue
                        doUpdateImage(image_uid, 'in queue', 0);
                        setTimeout(function () { getImageInfo(image_uid); }, 500);
                    }
                    else if (int_response == 0) {
                        //image processed
                        parseImageInfo(image_uid, xmlDoc);
                    }
                    else {
                        //error
                        doUpdateImage(image_uid, string_response, 0);

                        console.info(int_response);
                        console.info(string_response);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.info(textStatus);
                }
            });
        }

        function parseImageInfo(image_uid, xmlDocRoot) {
            var xmlDoc = $(xmlDocRoot).children("faces");

            doUpdateImage(image_uid, 'ok', $(xmlDoc).children("FaceInfo").length);

            var idx =0;
            $(xmlDoc).children("FaceInfo").each(function () {
                var face_uid = $(this).children("uid").text();
                var image_uid = $(this).children("image_uid").text();
                //
                var score = parseFloat($(this).children("score").text());
                //
                var x = parseFloat($(this).children("x").text());
                var y = parseFloat($(this).children("y").text());
                var width = parseFloat($(this).children("width").text());
                var height = parseFloat($(this).children("height").text());
                var angle = parseFloat($(this).children("angle").text());
                //
                var points = $(this).children("points").children();
                var tags = $(this).children("tags").children();
                //
                idx += 1;
                doAddFace(face_uid, image_uid, score, x, y, width, height, angle, points, tags, idx == $(xmlDoc).children("FaceInfo").length);
                //query face image
                doGetFaceImage(face_uid);

            });
        }

        function findImage(image_uid) {
            var ret = null;
            for (var i = window.Images.length - 1; i > -1; i--) {
                if (window.Images[i].id === image_uid) {
                    if (window.Images[i]['data'] != undefined) {
                        ret = window.Images[i].data;
                    }
                    break;
                }
            }
            return ret;
        }

        function findFaceImage(face_uid) {
            var ret = null;
            for (var i = window.Faces.length - 1; i > -1; i--) {
                if (window.Faces[i].id === face_uid) {
                    if (window.Faces[i]['data'] != undefined) {
                        ret = window.Faces[i].data;
                    }
                    break;
                }
            }
            return ret;
        }

        function parseRecognizeResponse(xmlDocRoot) {
            var recognize_uid = $(xmlDocRoot).children("recognize_uid").text();
            var xmlDoc = $(xmlDocRoot).children("faces_matches");
            $(xmlDoc).children("FaceRecognizeInfo").each(function () {
                for (var i = window.Matches.length - 1; i > -1; i--) {
                    if (window.Matches[i].id === recognize_uid) {
                        var face_uid = $(this).children("face_uid").text();
                        window.Matches[i].face_uid = face_uid;
                        window.Matches[i].data = findFaceImage(face_uid);
                        var matches = [];
                        $(this).children("matches").each(function () {
                            $(this).children("PersonMatchInfo").each(function () {
                                var match_face_uid = $(this).children("face_uid").text();
                                var match_person_name = $(this).children("person_name").text();
                                var match_is_match = $(this).children("is_match").text();
                                var match_confidence = parseFloat($(this).children("confidence").text());
                                var match_face_data = findFaceImage(match_face_uid);
                                var obj = {
                                    face_uid: match_face_uid,
                                    data: match_face_data,
                                    person_name: match_person_name,
                                    is_match: match_is_match,
                                    confidence: match_confidence
                                };
                                matches.push(obj);

                                if (null == match_face_data) {
                                    getFaceImage(match_face_uid);
                                }
                            });
                        });
                        window.Matches[i].matches = matches;
                        updateMatches();
                        break;
                    }
                }
            });
        }

        function getRecognizeResult(recognize_uid) {
            var msg = '<?xml version="1.0" encoding="utf-8"?><RecognizeResultRequest><api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>' +
                    '<recognize_uid>' + recognize_uid + '</recognize_uid></RecognizeResultRequest>';

            $.support.cors = true;
            $.ajax({
                crossDomain: true,
                url: 'http://www.betafaceapi.com/service.svc/GetRecognizeResult',
                type: 'post',
                contentType: 'application/xml',
                processData: false,
                data: msg,
                dataType: 'xml',
                success: function (data, textStatus, jqXHR) {
                    var xmlDocRoot = $.parseXML(jqXHR.responseText);
                    var xmlDoc = $(xmlDocRoot).children("BetafaceRecognizeResponse");
                    var int_response = parseInt($(xmlDoc).children("int_response").text());
                    var string_response = $(xmlDoc).children("string_response").text();

                    for (var i = window.Matches.length - 1; i > -1; i--) {
                        if (window.Matches[i].id === recognize_uid) {
                            window.Matches[i].status = string_response;
                        }
                    }
                    if (int_response == 1) {
                        //request is in the queue
                        setTimeout(function () { updateMatches(); }, 500);
                        setTimeout(function () { getRecognizeResult(recognize_uid); }, 500);
                    }
                    else if (int_response == 0) {
                        //request processed
                        parseRecognizeResponse(xmlDoc);
                    }
                    else {
                        //error
                        setTimeout(function () { updateMatches(); }, 500);
                        console.info(int_response);
                        console.info(string_response);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.info(textStatus);
                }
            });
        }

        function recognizeImpl(face_uid, targets) {
            var msg = '<?xml version="1.0" encoding="utf-8"?><FacesRecognizeRequest xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>';

            msg += '<faces_uids><guid xmlns="http://schemas.microsoft.com/2003/10/Serialization/Arrays">' + face_uid + '</guid></faces_uids>';
            msg += '<group_results>false</group_results><targets>';
            for (var i = 0; i < targets.length; i++) {
                msg += '<string xmlns="http://schemas.microsoft.com/2003/10/Serialization/Arrays">' + targets[i] + '</string>';
            }
            msg += '</targets>';        
            msg += '</FacesRecognizeRequest>';

            $.support.cors = true;
            $.ajax({
                crossDomain: true,
                url: 'http://www.betafaceapi.com/service.svc/Faces_Recognize',
                type: 'post',
                contentType: 'application/xml',
                processData: false,
                data: msg,
                dataType: 'xml',
                success: function (data, textStatus, jqXHR) {
                    var xmlDocRoot = $.parseXML(jqXHR.responseText);
                    var xmlDoc = $(xmlDocRoot).children("BetafaceRecognizeRequestResponse");
                    var int_response = parseInt($(xmlDoc).children("int_response").text());
                    var string_response = $(xmlDoc).children("string_response").text();
                    if (int_response == 0) {
                        var recognize_uid = $(xmlDoc).children("recognize_uid").text();
                        var match_obj = {
                            id: recognize_uid,
                            face_uid: face_uid,
                            status: 'Sent',
                            data: findFaceImage(face_uid),
                            matches: null
                        };
                        window.Matches.push(match_obj);
                        getRecognizeResult(recognize_uid);
                    }
                    else {
                        //error
                        console.info(int_response);
                        console.info(string_response);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.info(textStatus);
                }
            });
        }

        function doRecognizeFaces(face_uid) {
            if (window.Faces.length > 0) {
                var targets = [];
                for (var i = 0; i < window.Faces.length; i++) {
                    targets.push(window.Faces[i].id);
                }
                recognizeImpl(face_uid, targets);
            }
        }

        function doRecognizeCelebrities(face_uid) {
            var targets = new Array("all@celebrities.betaface.com");
            recognizeImpl(face_uid, targets);
        }

        function addPoints(image, container, points) {
            var container_offset = image.position();
            var width = image[0].width;
            var height = image[0].height;
            var orig_width = image[0].naturalWidth;
            var orig_height = image[0].naturalHeight;
            var x_scale = width / orig_width;
            var y_scale = height / orig_height;
            var color = '#FF0000';

            var handle_size = (x_scale * 4).toFixed();
            if (handle_size < 2) handle_size = 2;
            if (handle_size > 5) handle_size = 5;

            for(var i=0; i<points.length; i++)
            {
                var type = parseInt($(points[i]).children("type").text());
                var x = parseFloat($(points[i]).children("x").text());
                var y = parseFloat($(points[i]).children("y").text());

                var pt = $('<div></div>')
                        .css('position', 'absolute')
                        .css('left', (x * x_scale + container_offset.left).toFixed() + 'px')
                        .css('top', (y * y_scale + container_offset.top).toFixed() + 'px')
                        .css('width', handle_size + 'px')
                        .css('height', handle_size + 'px')
                        .css('background-color', color);

                $("#imageContainer").append(pt);
            }
        }

        function updateModal() {
            if(window.modal_on)
            {
                $("#imageContainer").empty();
                if (window.modal_is_image) {
                    $("#imageHeader").text("Image " + window.modal_id);
                    $("#imageContainer").append('<img class="image-image" id="imageModal" src="' + findImage(window.modal_id) + '"/>');
                    for (var i = 0; i < window.Faces.length; i++) {
                        if (window.Faces[i].image_uid === window.modal_id) {
                            addPoints($('#imageModal'), $("#imageContainer"), window.Faces[i].points);
                        }
                    }
                }
                else {
                    $("#imageHeader").text("Face " + window.modal_id);
                    $("#imageContainer").append('<img class="image-image" id="imageModal" src="' + findFaceImage(window.modal_id) + '"/>');
                    for (var i = 0; i < window.Faces.length; i++) {
                        if (window.Faces[i].id === window.modal_id) {
                            addPoints($('#imageModal'), $("#imageContainer"), window.Faces[i].cropped_points);
                            break;
                        }
                    }
                }
            }
        }

        function imageClick(image, image_uid) {
            window.modal_is_image = true;
            window.modal_id = image_uid;
            $('#myModal').modal();
        }
            
        function updateImages() {
            $('#images').html('<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" id="table_images"><thead><tr><th style="width:90px;text-align:center;vertical-align:middle;">Image</th><th>ID</th><th>Status</th><th>Faces</th></tr></thead></table>');
            $('#table_images').dataTable(
                {
                "sPaginationType": "bs_normal",
                "bLengthChange": false,
                "bFilter": false,
                "bSort": false,
                "bInfo": false,
                "bAutoWidth": false,
                "aaData": window.Images,
                "aoColumns": [
                    {
                        "mData": "data", "bSortable": false, "bSearchable": false,
                        "mRender": function (data, type, row) {
                            return ['<img onclick="imageClick(this,\'' + row.id + '\')"  class="thumb_c" src="', data, '" title="', escape(row.name), '"/>'].join('');
                        }
                    },
                    {
                        "mData": "id", "bSortable": false, "bSearchable": false
                    },
                    {
                        "mData": "status", "bSortable": false, "bSearchable": false
                    },
                    {
                        "mData": "faces", "bSortable": false, "bSearchable": false
                    }
                ]
            });
        }

        function faceClick(face, face_uid) {
            window.modal_is_image = false;
            window.modal_id = face_uid;
            $('#myModal').modal();
        }

        function updateFaces() {
            $('#faces').html('<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" id="table_faces"><thead><tr><th style="width:60px;text-align:center;vertical-align:middle;">Face</th><th style="width:120px;">Position</th><th>Classifiers and measurements</th><th style="width:160px;">Actions</th></tr></thead></table>');
            $('#table_faces').dataTable({
                "sPaginationType": "bs_normal",
                "bLengthChange": false,
                "bFilter": false,
                "bSort": false,
                "bInfo": false,
                "bAutoWidth": false,
                "aaData": window.Faces,
                "aoColumns": [
                    {
                        "mData": "data", "bSortable": false, "bSearchable": false,
                        "mRender": function (data, type, row) {
                            if (data != null) {
                                return ['<img onclick="faceClick(this,\'' + row.id + '\')" class="thumb_c" src="', data, '" title="', escape(row.id), '"/>'].join('');
                            }
                            return null;
                        }
                    },
                    {
                        "mData": "score", "bSortable": false, "bSearchable": false,
                        "mRender": function (score, type, row) {
                            return 'Score: ' + row.score + '</br>' +
                                'X: ' + parseFloat(row.x).toFixed(2) + '</br>Y: ' + parseFloat(row.y).toFixed(2) +
                                '</br>Width: ' + parseFloat(row.width).toFixed(2) + '</br>Height: ' + parseFloat(row.height).toFixed(2) + '</br>Angle: ' + parseFloat(row.angle).toFixed(2) + '</br>';
                        }
                    },
                    {
                        "mData": "tags", "bSortable": false, "bSearchable": false,
                        "mRender": function (tags, type, row) {
                            var ret='';
                            if ($(tags).length > 0) {
                                $(tags).each(function () {
                                    if (ret != '') {
                                        ret += ', ';
                                    }
                                    ret += $(this).children("name").text() + ' : ' + $(this).children("value").text();
                                    if((parseFloat($(this).children("confidence").text()) * 100) < 100)
                                    {
                                        ret += ' (' + (parseFloat($(this).children("confidence").text()) * 100).toFixed() + '%)';
                                    }
                                })
                            }
                            return '<div id="classifiers" class="expandable">' + ret + '</div>';
                        }
                    },
                    {
                        "mData": null, "bSortable": false, "bSearchable": false,
                        "mRender": function (data, type, row) {
                            return '<a href="#" onclick="doRecognizeFaces(\'' + row.id + '\');">Recognize faces</a>' + '</br>' +
                                    '<a href="#" onclick="doRecognizeCelebrities(\'' + row.id + '\');">Recognize celebrities</a>';
                        }
                    },
                ]
            });
            $('tr td div#classifiers.expandable').expander({
                slicePoint: 250,
                userCollapseText: '[collapse]'
            });
        }

        function updateMatches() {
            $('#matches').html('<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" id="table_matches"><thead><tr><th style="width:60px;text-align:center;vertical-align:middle;">Face</th><th>Matches</th></tr></thead></table>');
            $('#table_matches').dataTable({
                "sPaginationType": "bs_normal",
                "bLengthChange": false,
                "bFilter": false,
                "bSort": false,
                "bInfo": false,
                "bAutoWidth": false,
                "aaData": window.Matches,
                "aoColumns": [
                    {
                        "mData": "face_uid", "bSortable": false, "bSearchable": false,
                        "mRender": function (face_uid, type, row) {
                            if (face_uid != null && row.data != null) {
                                return ['<img class="thumb" style="vertical-align:middle" src="', row.data, '" title="', escape(face_uid), '"/>'].join('');
                            }
                            return null;
                        }
                    },
                    {
                        "mData": "matches", "bSortable": false, "bSearchable": false,
                        "mRender": function (matches, type, row) {
                            var ret = '';
                            if (matches == null) {
                                return row.status;
                            }
                            if ($(matches).length > 0) {
                                $(matches).each(function () {
                                    //escape()
                                    ret += ['<img class="thumb" style="margin: 0px 5px; vertical-align:middle" src="', $(this)[0].data, '" title="', $(this)[0].person_name + ' ' + $(this)[0].is_match + ' ' + ($(this)[0].confidence * 100).toFixed() + '%', '"/>'].join('');
                                })
                            }
                            return ret;
                        }
                    },
                ]
            });
        }

        function doAddFace(face_uid, image_uid, score, x, y, width, height, angle, points, tags, update_faces) {
            setTimeout(function () { addFace(face_uid, image_uid, score, x, y, width, height, angle, points, tags, update_faces); }, 500);
        }

        function doUpdateFace(face_uid, face_image_data, x, y, width, height, angle, points){
            setTimeout(function () { updateFace(face_uid, face_image_data, x, y, width, height, angle, points); }, 200);
        }

        function doAddImage(image_uid, image_filename, image_data) {
            setTimeout(function () { addImage(image_uid, image_filename, image_data); }, 200);
        }

        function doUpdateImage(image_uid, status, faces) {
            setTimeout(function () { updateImage(image_uid, status, faces); }, 200);
        }

        function doGetFaceImage(face_uid) {
            setTimeout(function () { getFaceImage(face_uid); }, 200);
        }

        function addImage(image_uid, filename, image_data)
        {
            var bfound = false;
            for (var i = window.Images.length - 1; i > -1; i--) {
                if (window.Images[i].id === image_uid) {
                    window.Images[i].filename = filename;
                    window.Images[i].data = image_data;
                    window.Images[i].faces = 0;
                    window.Images[i].status = 'uploaded';
                    bfound = true;
                    break;
                }
            }
            if (!bfound) {
                // add image to the storage
                var obj = {
                    id: image_uid,
                    name: filename,
                    data: image_data,
                    faces: 0,
                    status: 'uploaded'
                };
                window.Images.push(obj);

                //query info
                getImageInfo(image_uid);
            }

            updateImages();
        }

        function updateImage(image_uid, status, faces) {
            var bfound = false;
            for (var i = window.Images.length - 1; i > -1; i--) {
                if (window.Images[i].id === image_uid) {
                    window.Images[i].faces = faces;
                    window.Images[i].status = status;
                    bfound = true;
                    break;
                }
            }
            updateImages();
        }

        function addFace(face_uid, image_uid, score, x, y, width, height, angle, points, tags, update_faces) {
            var bfound = false;
            for (var i = window.Faces.length - 1; i > -1; i--) {
                if (window.Faces[i].id === face_uid) {
                    window.Faces[i].image_uid = image_uid;
                    window.Faces[i].score = score;
                    window.Faces[i].x = x;
                    window.Faces[i].y = y;
                    window.Faces[i].width = width;
                    window.Faces[i].height = height;
                    window.Faces[i].angle = angle;
                    window.Faces[i].points = points;
                    window.Faces[i].tags = tags;
                    bfound = true;
                    break;
                }
            }
            if (!bfound) {
                // add face to the storage
                var obj = {
                    id: face_uid,
                    image_uid: image_uid,
                    score: score,
                    x: x,
                    y: y,
                    width: width,
                    height: height,
                    angle: angle,
                    points: points,
                    tags: tags,
                    data: null,
                    cropped_x: null,
                    cropped_y: null,
                    cropped_width: null,
                    cropped_height: null,
                    cropped_angle: null,
                    cropped_points: null
                };
                window.Faces.push(obj);
            }
            if (update_faces) {
                updateFaces();
                //
                if (window.modal_on && window.modal_is_image && (window.modal_id === image_uid)) {
                    updateModal();
                }
            }
        }

        function updateFace(face_uid, face_image_data, x, y, width, height, angle, points) {
            var update_faces = false;
            for (var i = window.Faces.length - 1; i > -1; i--) {
                if (window.Faces[i].id === face_uid) {
                    window.Faces[i].data = face_image_data;
                    window.Faces[i].cropped_x = x;
                    window.Faces[i].cropped_y = y;
                    window.Faces[i].cropped_width = width;
                    window.Faces[i].cropped_height = height;
                    window.Faces[i].cropped_angle = angle;
                    window.Faces[i].cropped_points = points;
                    update_faces = true;
                    break;
                }
            }

            var update_matches = false;
            for (var i = window.Matches.length - 1; i > -1; i--) {
                if (window.Matches[i].face_uid === face_uid) {
                    window.Matches[i].data = face_image_data;
                    update_matches = true;
                }
                for (var j = 0; j<window.Matches[i].matches.length; j++) {
                    if (window.Matches[i].matches[j].face_uid === face_uid) {
                        window.Matches[i].matches[j].data = face_image_data;
                        update_matches = true;
                    }
                }
            }

            if (update_faces) {
                updateFaces();
            }
            if (update_matches) {
                updateMatches();
            }
        }

        function loadFile(file) {
            setTimeout(function () {
                var reader = new FileReader();

                reader.onload = (function (theFile) {
                    return function (e) {
                        if (reader.readyState == FileReader.DONE) {
                            var data_url = e.target.result;
                            uploadImageFile(theFile.name, data_url, 'cropface,recognition,propoints,classifiers,extended');
                        }

                    }
                })(file);
                reader.readAsDataURL(file);
            }, 100);
        }

        function handleSelectedFiles(files) {
            for (var i = 0, f; f = files[i]; i++) {
                // Only process image files.
                if (!f.type.match('image.*')) {
                    continue;
                }

                loadFile(f);
            }
        }

        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object

            handleSelectedFiles(files);
        }

        function doUploadUrl() {
            uploadImageUrl($("#txtUrl")[0].value, 'cropface,recognition,propoints,classifiers,extended');
        }


        $("#txtUrl").keyup(function (event) {
            if (event.keyCode == 13) {
                $("#btnUrl").click();
            }
        });

        $('#myModal').on('show', function () {
            $(this).find('.modal-body').css({
                width: 'auto',
                height: 'auto',
                'max-height': '100%'
            });
        });

        $('#myModal').on('shown.bs.modal', function () {
            window.modal_on = true;
            updateModal();
        })

        $('#myModal').on('hidden.bs.modal', function () {
            window.modal_on = false;
        })

        document.getElementById('files').addEventListener('change', handleFileSelect, false);
    </script>
</body>
</html>
